apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: immich-pg16
  namespace: postgres
spec:
  bootstrap:
    initdb:
      postInitSQL:
        - CREATE EXTENSION IF NOT EXISTS vchord CASCADE;
  enableSuperuserAccess: true
  imageCatalogRef:
    apiGroup: postgresql.cnpg.io
    kind: ImageCatalog
    major: 17
    name: vectorchord
  instances: 2
  monitoring:
    enablePodMonitor: false
  plugins:
    - isWALArchiver: true
      name: barman-cloud.cloudnative-pg.io
      parameters:
        barmanObjectName: prod
  postgresql:
    parameters:
      max_slot_wal_keep_size: 1GB
    shared_preload_libraries:
      - vchord.so
  resources:
    limits:
      cpu: 600m
      memory: 768Mi
    requests:
      cpu: 600m
      memory: 768Mi
  storage:
    size: 15Gi
    storageClass: ceph-rbd
