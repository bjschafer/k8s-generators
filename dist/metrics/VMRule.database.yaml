apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  labels:
    alerts.cmdcentral.xyz/kind: metrics
  name: database
  namespace: metrics
spec:
  groups:
    - name: database
      rules:
        - alert: CNPGVolumeAlmostFull
          annotations:
            summary: CNPG volume {{ $labels.persistentvolumeclaim }} is > 85% full
          expr: max(max by(persistentvolumeclaim) (1 - kubelet_volume_stats_available_bytes{namespace="postgres"} / kubelet_volume_stats_capacity_bytes{namespace="postgres"})) > 0.85
          for: 15m
          labels:
            namespace: metrics
            priority: "0"
            push_notify: "true"
        - alert: CNPGMaxConnectionsReached
          annotations:
            summary: CNPG pod {{ $labels.pod }}'s connections are > 90% used
          expr: 100 * sum by (pod) (cnpg_backends_total{namespace=~"postgres"}) / sum by (pod) (cnpg_pg_settings_setting{name="max_connections", namespace=~"postgres"}) > 90
          for: 5m
          labels:
            namespace: metrics
            priority: "0"
            push_notify: "true"
        - alert: CNPGClusterNotHealthy
          annotations:
            summary: CNPG cluster {{ $labels.cluster }} has unhealthy instances
          expr: cnpg_cluster_instances_status{status!="ready"} > 0
          for: 5m
          labels:
            namespace: metrics
            priority: "1"
            push_notify: "true"
        - alert: CNPGReplicationLag
          annotations:
            summary: CNPG replication lag on {{ $labels.pod }} is {{ $value }}s
          expr: cnpg_pg_replication_lag > 60
          for: 5m
          labels:
            namespace: metrics
            priority: "0"
            push_notify: "true"
        - alert: CNPGBackupFailed
          annotations:
            summary: CNPG backup failed for cluster {{ $labels.cluster }}
          expr: increase(cnpg_collector_last_failed_backup_timestamp[1h]) > 0
          for: 0m
          labels:
            namespace: metrics
            priority: "0"
            push_notify: "true"
