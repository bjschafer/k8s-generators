apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  labels:
    alerts.cmdcentral.xyz/kind: metrics
  name: ups
  namespace: metrics
spec:
  groups:
    - name: ups
      rules:
        - alert: UpsOnBattery
          annotations:
            summary: UPS {{ $labels.ups }} is running on battery!
          expr: nut_status{status='OB'} == 1
          for: 0m
          labels:
            namespace: metrics
            priority: "1"
            push_notify: "true"
        - alert: UpsLowBattery
          annotations:
            summary: UPS {{ $labels.ups }} battery is below 50% ({{ $value }}%)
          expr: nut_battery_charge < 50
          for: 1m
          labels:
            namespace: metrics
            priority: "1"
            push_notify: "true"
        - alert: UpsHighLoad
          annotations:
            description: |-
              UPS load on {{ $labels.ups }}
                VALUE = {{ $value }}
                LABELS = {{ $labels }}
            summary: UPS load over 75% on UPS {{ $labels.ups }}
          expr: nut_load * 100 > 75
          for: 5m
          labels:
            namespace: metrics
            priority: "0"
        - alert: UpsBatteryReplacementNeeded
          annotations:
            summary: UPS {{ $labels.ups }} battery is over 3 years old
          expr: nut_battery_mfr_date_seconds > 0 and (time() - nut_battery_mfr_date_seconds) > (3 * 365 * 24 * 3600)
          for: 1d
          labels:
            priority: "-1"
