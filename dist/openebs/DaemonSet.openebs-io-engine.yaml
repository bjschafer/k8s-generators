apiVersion: apps/v1
kind: DaemonSet
metadata:
  labels:
    app: io-engine
    openebs.io/release: openebs
    openebs.io/version: 2.8.0
  name: openebs-io-engine
spec:
  minReadySeconds: 10
  selector:
    matchLabels:
      app: io-engine
      openebs.io/release: openebs
  template:
    metadata:
      labels:
        app: io-engine
        openebs.io/logging: "true"
        openebs.io/release: openebs
        openebs.io/version: 2.8.0
    spec:
      containers:
        - args:
            - --fmt-style=pretty
            - --ansi-colors=true
          env:
            - name: MY_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          image: docker.io/openebs/mayastor-metrics-exporter-io-engine:v2.8.0
          imagePullPolicy: IfNotPresent
          name: metrics-exporter-io-engine
          ports:
            - containerPort: 9502
              name: metrics
              protocol: TCP
        - args:
            - --grpc-ip=$(MY_POD_IP)
            - -N$(MY_NODE_NAME)
            - -Rhttps://openebs-agent-core:50051
            - -y/var/local/openebs/io-engine/config.yaml
            - -l1,2
            - -p=openebs-etcd:2379
            - --ptpl-dir=/var/local/openebs/io-engine/ptpl/
            - --api-versions=v1
            - --tgt-crdt=30
            - --events-url=nats://openebs-nats:4222
            - --ps-retries=300
          command:
            - io-engine
          env:
            - name: RUST_LOG
              value: info
            - name: NVMF_TCP_MAX_QPAIRS_PER_CTRL
              value: "32"
            - name: NVMF_TCP_MAX_QUEUE_DEPTH
              value: "32"
            - name: NVME_TIMEOUT
              value: 110s
            - name: NVME_TIMEOUT_ADMIN
              value: 30s
            - name: NVME_KATO
              value: 10s
            - name: MY_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: NEXUS_NVMF_ANA_ENABLE
              value: "1"
            - name: NEXUS_NVMF_RESV_ENABLE
              value: "1"
          image: docker.io/openebs/mayastor-io-engine:v2.8.0
          imagePullPolicy: IfNotPresent
          name: io-engine
          ports:
            - containerPort: 10124
              name: io-engine
              protocol: TCP
          resources:
            limits:
              cpu: "2"
              hugepages-2Mi: 2Gi
              memory: 1Gi
            requests:
              cpu: "2"
              hugepages-2Mi: 2Gi
              memory: 1Gi
          securityContext:
            privileged: true
          volumeMounts:
            - mountPath: /dev
              name: device
            - mountPath: /run/udev
              name: udev
            - mountPath: /dev/shm
              name: dshm
            - mountPath: /var/local/openebs/io-engine/
              name: configlocation
            - mountPath: /dev/hugepages
              name: hugepage
      dnsPolicy: ClusterFirstWithHostNet
      hostNetwork: true
      initContainers:
        - command:
            - sh
            - -c
            - trap "exit 1" TERM; until nc -vzw 5 openebs-agent-core 50051; do date; echo "Waiting for agent-core-grpc services..."; sleep 1; done;
          image: docker.io/openebs/alpine-sh:4.1.0
          imagePullPolicy: IfNotPresent
          name: agent-core-grpc-probe
        - command:
            - sh
            - -c
            - trap "exit 1" TERM; until nc -vzw 5 openebs-etcd 2379; do date; echo "Waiting for etcd..."; sleep 1; done;
          image: docker.io/openebs/alpine-sh:4.1.0
          imagePullPolicy: IfNotPresent
          name: etcd-probe
      nodeSelector:
        kubernetes.io/arch: amd64
        openebs.io/engine: mayastor
      volumes:
        - hostPath:
            path: /dev
            type: Directory
          name: device
        - hostPath:
            path: /run/udev
            type: Directory
          name: udev
        - emptyDir:
            medium: Memory
            sizeLimit: 1Gi
          name: dshm
        - emptyDir:
            medium: HugePages
          name: hugepage
        - hostPath:
            path: /var/local/openebs/io-engine/
            type: DirectoryOrCreate
          name: configlocation
  updateStrategy:
    type: OnDelete
