apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app.kubernetes.io/instance: openebs
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: nats
    app.kubernetes.io/version: 2.9.17
    helm.sh/chart: nats-0.19.14
  name: openebs-nats
  namespace: openebs
spec:
  podManagementPolicy: Parallel
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/instance: openebs
      app.kubernetes.io/name: nats
  serviceName: openebs-nats
  template:
    metadata:
      annotations:
        checksum/config: e4e59e32c0128fae11bf52af4b733c364d878e4619792f720850b606df60fbd2
        prometheus.io/path: /metrics
        prometheus.io/port: "7777"
        prometheus.io/scrape: "true"
      labels:
        app: nats
        app.kubernetes.io/instance: openebs
        app.kubernetes.io/name: nats
        openebs.io/logging: "true"
    spec:
      containers:
        - command:
            - nats-server
            - --config
            - /etc/nats-config/nats.conf
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: SERVER_NAME
              value: $(POD_NAME)
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: CLUSTER_ADVERTISE
              value: $(POD_NAME).openebs-nats.$(POD_NAMESPACE)
          image: nats:2.9.17-alpine
          imagePullPolicy: IfNotPresent
          lifecycle:
            preStop:
              exec:
                command:
                  - nats-server
                  - -sl=ldm=/var/run/nats/nats.pid
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: 8222
            initialDelaySeconds: 10
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 5
          name: nats
          ports:
            - containerPort: 4222
              name: client
            - containerPort: 6222
              name: cluster
            - containerPort: 8222
              name: monitor
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: 8222
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          resources: {}
          startupProbe:
            failureThreshold: 90
            httpGet:
              path: /healthz
              port: 8222
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          volumeMounts:
            - mountPath: /etc/nats-config
              name: config-volume
            - mountPath: /var/run/nats
              name: pid
        - command:
            - nats-server-config-reloader
            - -pid
            - /var/run/nats/nats.pid
            - -config
            - /etc/nats-config/nats.conf
          image: natsio/nats-server-config-reloader:0.10.1
          imagePullPolicy: IfNotPresent
          name: reloader
          resources: {}
          volumeMounts:
            - mountPath: /etc/nats-config
              name: config-volume
            - mountPath: /var/run/nats
              name: pid
        - args:
            - -connz
            - -routez
            - -subz
            - -varz
            - -prefix=nats
            - -use_internal_server_id
            - -jsz=all
            - http://localhost:8222/
          image: natsio/prometheus-nats-exporter:0.11.0
          imagePullPolicy: IfNotPresent
          name: metrics
          ports:
            - containerPort: 7777
              name: metrics
          resources: {}
      dnsPolicy: ClusterFirst
      serviceAccountName: openebs-nats
      shareProcessNamespace: true
      terminationGracePeriodSeconds: 60
      volumes:
        - configMap:
            name: openebs-nats-config
          name: config-volume
        - emptyDir: {}
          name: pid
