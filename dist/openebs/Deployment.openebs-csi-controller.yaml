apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: csi-controller
    openebs.io/release: openebs
    openebs.io/version: 2.8.0
  name: openebs-csi-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: csi-controller
      openebs.io/release: openebs
  template:
    metadata:
      labels:
        app: csi-controller
        openebs.io/logging: "true"
        openebs.io/release: openebs
        openebs.io/version: 2.8.0
    spec:
      containers:
        - args:
            - --v=2
            - --csi-address=$(ADDRESS)
            - --feature-gates=Topology=true
            - --strict-topology=false
            - --default-fstype=ext4
            - --extra-create-metadata
            - --timeout=36s
            - --worker-threads=10
            - --prevent-volume-mode-conversion
          env:
            - name: ADDRESS
              value: /var/lib/csi/sockets/pluginproxy/csi.sock
          image: registry.k8s.io/sig-storage/csi-provisioner:v3.5.0
          imagePullPolicy: IfNotPresent
          name: csi-provisioner
          volumeMounts:
            - mountPath: /var/lib/csi/sockets/pluginproxy/
              name: socket-dir
        - args:
            - --v=2
            - --timeout=36s
            - --csi-address=$(ADDRESS)
          env:
            - name: ADDRESS
              value: /var/lib/csi/sockets/pluginproxy/csi.sock
          image: registry.k8s.io/sig-storage/csi-attacher:v4.3.0
          imagePullPolicy: IfNotPresent
          name: csi-attacher
          volumeMounts:
            - mountPath: /var/lib/csi/sockets/pluginproxy/
              name: socket-dir
        - args:
            - --v=2
            - --csi-address=$(ADDRESS)
          env:
            - name: ADDRESS
              value: /var/lib/csi/sockets/pluginproxy/csi.sock
          image: registry.k8s.io/sig-storage/csi-snapshotter:v6.3.3
          imagePullPolicy: IfNotPresent
          name: csi-snapshotter
          volumeMounts:
            - mountPath: /var/lib/csi/sockets/pluginproxy/
              name: socket-dir
        - args:
            - --v=2
            - --leader-election=false
            - --prevent-volume-mode-conversion
          image: registry.k8s.io/sig-storage/snapshot-controller:v6.3.3
          imagePullPolicy: IfNotPresent
          name: csi-snapshot-controller
        - args:
            - --v=2
            - --csi-address=$(ADDRESS)
            - --handle-volume-inuse-error=false
          env:
            - name: ADDRESS
              value: /var/lib/csi/sockets/pluginproxy/csi.sock
          image: registry.k8s.io/sig-storage/csi-resizer:v1.9.3
          imagePullPolicy: IfNotPresent
          name: csi-resizer
          volumeMounts:
            - mountPath: /var/lib/csi/sockets/pluginproxy/
              name: socket-dir
        - args:
            - --csi-socket=/var/lib/csi/sockets/pluginproxy/csi.sock
            - --rest-endpoint=http://openebs-api-rest:8081
            - --node-selector=openebs.io/csi-node=mayastor
            - --ansi-colors=true
            - --fmt-style=pretty
            - --create-volume-limit=10
          env:
            - name: RUST_LOG
              value: info
          image: docker.io/openebs/mayastor-csi-controller:v2.8.0
          imagePullPolicy: IfNotPresent
          name: csi-controller
          resources:
            limits:
              cpu: 32m
              memory: 128Mi
            requests:
              cpu: 16m
              memory: 64Mi
          volumeMounts:
            - mountPath: /var/lib/csi/sockets/pluginproxy/
              name: socket-dir
      dnsPolicy: ClusterFirstWithHostNet
      hostNetwork: true
      initContainers:
        - command:
            - sh
            - -c
            - trap "exit 1" TERM; until nc -vzw 5 openebs-api-rest 8081; do date; echo "Waiting for REST API endpoint to become available"; sleep 1; done;
          image: docker.io/openebs/alpine-sh:4.1.0
          imagePullPolicy: IfNotPresent
          name: api-rest-probe
      nodeSelector:
        kubernetes.io/arch: amd64
      priorityClassName: openebs-cluster-critical
      serviceAccountName: openebs-service-account
      tolerations:
        - effect: NoExecute
          key: node.kubernetes.io/unreachable
          operator: Exists
          tolerationSeconds: 5
        - effect: NoExecute
          key: node.kubernetes.io/not-ready
          operator: Exists
          tolerationSeconds: 5
      volumes:
        - name: socket-dir
